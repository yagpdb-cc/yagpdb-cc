{{/*
        Counting command. Count and have fun!
        
	See <https://yagpdb-cc.github.io/fun/counting-v2>
	
        Author: H1nr1 <https://github.com/H1nr1>
*/}}

{{/* Configurable Values */}}
{{ $Admin := 123456789 }} {{/* Administrator role ID; EDIT THIS TO A ROLE ID YOU HAVE */}}
{{/* Optional */}}
{{ $CountTwice := true }} {{/* Allow users to count multiple times in a row; true/false */}}
{{ $RoleID := false }} {{/* Counting role ID; set to false to disable */}}
{{ $SecondChance := true }} {{/* Second chance if wrong; true/false */}}
{{ $StatsCC := true }} {{/* If you added the Stats CC; true/false */}}
{{ $Reactions := true }} {{/* Allow confirmative reactions on message; true false */}}
	{{ $RDeleteDelay := 60 }} {{/* Delay to remove reaction; set to false to disable */}}
	{{ $CorrectEmoji := "‚úÖ" }} {{/* Emoji to react with if number is correct; if custom, use format name:id */}}
	{{ $WarningEmoji := "‚ö†Ô∏è" }} {{/* Emoji to react with if wrong number AND Second Chance is true/on; if custom, use format name:id */}}
	{{ $IncorrectEmoji := "‚ùå" }} {{/* Emoji to react with if number is incorrect; if custom, use format name:id */}}
{{/* End of configuration values */}}

{{/* No Touchy */}}
{{ with .ExecData }}
	{{ if not (getMessage nil .) }} {{/* Check if number was deleted */}}
		{{ sendMessage nil (cembed 
			"description" (print "<@" (dbGet 0 "LastUser").Value "> deleted their number which was correct!\nThe next number is " (dbGet 0 "Next").Value)
			"color" 30654) }}
	{{ return }}{{ end }}
{{ return }}{{ end }}

{{/* Initializing variables */}}
{{ $LastUser := toInt (dbGet 0 "LastUser").Value }}
{{ $Next := (dbGet 0 "Next").Value }}
{{ $Number := "" }}
{{ $Number = round (slice (exec "calc" (index .Args 0)) 9 (len $Number | add -1)) }}
{{ $Wrong := "" }}
{{ if $SecondChance }}
	{{ $Wrong = (dbGet 0 "CSecondChance").Value }}
{{ end }}
{{ $Silence := "" }}

{{ if and (hasRoleID $Admin) (eq (toInt $Number) 0) }}
	{{ if lt (toInt (dbGet 0 "Admin").Value) 1 }}
		{{ dbSet 0 "LastUser" (toString .User.ID) }}
		{{ dbSet 0 "Next" 1 }}
		{{ dbIncr 0 "Admin" 1 }}
		{{ addReactions $CorrectEmoji }}
	{{ return }}
	{{ end }}
{{ end }}

{{ if or (ne $LastUser .User.ID) $CountTwice }} {{/* Checks user */}}
	{{ if eq (toInt $Next) (toInt $Number) }} {{/* Checks if correct number */}}
		{{ if $Reactions }}
			{{ addReactions $CorrectEmoji }}
		{{ end }}
		{{ dbSet 0 "Next" (add $Next 1) }}
		{{ dbSet 0 "LastUser" (toString .User.ID) }}
		{{ if not $RoleID }} {{/* Counting role */}}
			{{ takeRoleID $LastUser $RoleID 1 }}
			{{ giveRoleID .User.ID $RoleID }}
		{{ end }}
		{{ if $StatsCC }} {{/* Updates statistical values */}}
			{{ $Silence = dbIncr .User.ID "CCorrect" 1 }}
			{{ $Silence = dbIncr .User.ID "CCount" 1 }}
			{{ if gt (toInt $Number) (toInt (dbGet 0 "CHighScore").Value) }}
				{{ dbSet 0 "CHighScore" (toInt $Number) }}
				{{ dbSet 0 "CHSUser" (toString .User.ID) }}
			{{ end }}
		{{ end }}
		{{ execCC .CCID nil 10 .Message.ID }} {{/* Calls check for if number was deleted */}}
		
	{{ else }} {{/* Wrong number */}}
		{{ if $SecondChance }}
			{{ $Wrong = dbIncr 0 "CSecondChance" 1 }}
			{{ if eq (toInt $Wrong) 1 }} {{/* Saved count */}}
				{{ if $Reactions }}
					{{ addReactions $WarningEmoji }}
				{{ end }}
				{{ sendMessage nil (cembed 
					"description" (print "<@" .User.ID "> sent an incorrect number of " $Number "\n**But**, second chance saved the count!\nThe next number is " $Next)
					"color" 16744192) }}
			{{ else if ge (toInt $Wrong) 2 }} {{/* Reset count */}}
				{{ if $Reactions }}
					{{ addReactions $IncorrectEmoji }}
				{{ end }}
				{{ sendMessage nil (cembed 
					"description" (print "<@" .User.ID "> sent an incorrect number of " $Number "\nCorrect number was " $Next "\nStart over at 1 üôÉ")
					"color" 16711680) }}
				{{ dbSet 0 "Next" "1" }}
				{{ if not $CountTwice }}
					{{ dbSet 0 "LastUser" 0 }}
				{{ end }}
				{{ dbSet 0 "CSecondChance" 0 }}
				{{ if $StatsCC }}
					{{ $Silence = dbIncr .User.ID "CCount" 1 }}
				{{ end }}
			{{ end }}
			
		{{ else if or (ge (toInt $Wrong) 2) (not $SecondChance) }} {{/* Reset count */}}
			{{ if $Reactions }}
				{{ addReactions $IncorrectEmoji }}
			{{ end }}
			{{ sendMessage nil (cembed 
				"description" (print "<@" .User.ID "> sent an incorrect number of " $Number "\nCorrect number was " $Next "\nStart over at 1 üôÉ")
				"color" 16711680) }}
			{{ dbSet 0 "Next" "1" }}
			{{ if not $CountTwice }}
				{{ dbSet 0 "LastUser" 0 }}
			{{ end }}
			{{ if $SecondChance }}
				{{ dbSet 0 "CSecondChance" 0 }}
			{{ end }}
			{{ if $StatsCC }}
				{{ $Silence = dbIncr .User.ID "CCount" 1 }}
			{{ end }}
		{{ end }}
	{{ end }}
	
{{ else }} {{/* Same user */}}
	{{ sendMessage nil (cembed 
		"description" (print "You can't count twice in a row ü•≤\nThe next number is " $Next)
		"color" 16744192) }}
{{ end }}
